# mashparser — GUI
## Описание проекта

Это локальная утилита с веб-интерфейсом для парсинга карточек товаров с сайта (реализован для каталога Tinko). Программа запускает headless-браузер, собирает поля товара и формирует CSV.

Функции и возможности
- Добавление списка артикулов вручную (через UI).
- Кнопка "Спарсить" запускает парсинг и показывает потоковые логи в реальном времени (SSE).
- Если в процессе парсинга встречаются слишком длинные имена атрибутов (>= 28 символов), UI предложит ввести сокращения — парсинг можно продолжить после подтверждения замен.
- Замены сохраняются в файл `replaceNames.json` (и дублируются в `config.js`) — они применяются при следующих запусках.
- История запусков сохраняется в `history.json` и доступна в UI через кнопку "История".

Краткая структура репозитория
- `server.js` — Express-сервер, API, управление запусками, запись истории и замен.
- `scraper.js` — модуль парсинга; использует Playwright и Cheerio; поддерживает AbortSignal для отмены.
- `public/` — статические файлы фронтенда (HTML/CSS/JS).
- `config.js` — исходный файл конфигурации с примерами `replaceNames` и `articles`.
- `replaceNames.json` — файл, в который сохраняются пользовательские замены длинных имён.
- `history.json` — файл истории запусков парсинга.

Запуск
1) Установите зависимости (один раз):

```powershell
npm install
```

2) Запуск сервера GUI:

```powershell
npm start
```

Откройте в браузере: http://localhost:3000

Как пользоваться (порядок действий)
1. В поле введите артикул и нажмите "Добавить" (Enter работает как добавление).
2. Повторите для всех артикулов или вставьте их по одному.
3. Нажмите "Спарсить". В окне логов вы увидите сообщения в реальном времени.
4. Если появится модальное окно с длинными именами атрибутов — введите замену (каждая замена должна быть короче 28 символов) и нажмите "Парсить снова".
5. После успешного завершения появится кнопка "Скачать CSV".
6. Кнопка "История" показывает список предыдущих запусков с возможностью скачать CSV по runId (если он был создан).

Принцип работы (детально)
- Сервер (`server.js`) принимает POST /start с массивом артикулов. Создаётся уникальный runId (метка времени).
- Сервер запускает `scrapeAllProducts` из `scraper.js` в фоновом таске и подписывает клиента на события через SSE (`/events/:runId`).
- `scraper.js` открывает headless Chromium (Playwright), последовательно посещает страницы товаров, собирает информацию (название, производитель, цена, описание, характеристики, ссылки на документы/сертификаты) и формирует массив объектов.
- Если при обработке характеристик встречается имя атрибута длиной >= 28 символов и для него нет замены в `replaceNames`, парсер возвращает список таких длинных имён. Сервер отправляет событие `need_replacements` и сохраняет запись в `history.json` со статусом `need_replacements`.
- Клиент (браузер) показывает модальное окно, где пользователь может ввести замену для каждого длинного имени. При подтверждении браузер отправляет `/apply-replacements` с runId и картой замен. Сервер сохраняет замены в `replaceNames.json` (и в `config.js`) и перезапускает парсинг для этого runId.
- При успешном завершении сервер сохраняет CSV в памяти (в RAM map) и отправляет событие `done` с именем файла; клиент предлагает скачать CSV по `/download/:runId`.
- Все важные события (done, error, cancelled и need_replacements) записываются в `history.json` для просмотра в UI.

Отмена парсинга
- Если пользователь закрыл модальное окно с запросом замен (кнопка Отмена), сервер получает POST /cancel и вызывает AbortController для соответствующего runId — процесс парсинга прерывается, и сервер ставит в историю статус `cancelled`.

Файлы конфигурации
- `config.js` сохраняется автоматически при обновлении замен — это обеспечивает обратную совместимость со старым CLI (`index.js`).
- `replaceNames.json` — основной файл для быстрого чтения/записи замен; если он присутствует, сервер предпочитает его.
- `history.json` — массив объектов истории. Каждая запись содержит: runId, timestamp, status, articles, filename (если есть) и message.

Советы по отладке
- Если фронтенд показывает 404 при обращении к `/api/replace-names.json`, откройте в браузере `/api/ping` и `/__routes` — эти эндпоинты помогают выяснить, отвечает ли тот же процесс сервера. Также проверьте расширения браузера и ServiceWorker (иногда они кешируют старые ответы).
- Логи сервера выводятся в консоль, где вы запускали `npm start`.

Безопасность и ограничения
- Этот проект запускается локально и не предназначен для публичного размещения без доработок по безопасности.
- Playwright загружает браузер и использует ресурсы машины; для большого количества артикулов учитывайте нагрузку и задержки между запросами.

Дополнения и возможные улучшения
- Переключатель политики сохранения замен (merge vs overwrite).
- Очистка старых файлов CSV на диске (если будет добавлено сохранение на диск).
- Пагинация и фильтры в интерфейсе Истории.

Автор и поддержка
Проект — пример локального GUI для парсинга; если нужны доработки, опишите требуемое поведение и я помогу внести изменения.

---
Файлы, создаваемые при работе: `replaceNames.json`, `history.json` (в корне проекта).
